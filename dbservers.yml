- hosts: localhost
  connection: local

  tasks:
    - name: Create multi-zone Postgres on RDS
      local_action:
        module: rds
        command: create
        instance_name: "{{ db_instance }}"
        region: us-east-1
        db_engine: postgres
        instance_type: db.t2.micro
        multi_zone: yes
        publicly_accessible: yes
        size: 500
        maint_window: mon:05:00-mon:06:00
        backup_retention: 35
        backup_window: 07:00-07:30
        license_model: license-included
        db_name: "{{ db_name }}"
        username: "{{ db_user }}"
        password: "{{ db_password }}"
        tags:
          environment: testing
          application: worldmap
          owner: ariel

    - name: Get facts about postgres instance.
      local_action:
        module: rds
        command: facts
        instance_name: "{{ db_instance }}"
        register: postgres_facts

    - name: Ensure postgresql postgis extension is created
      shell: "PGPASSWORD='{{db_password}}' psql -h {{db_host}} -d {{db_name}} -U {{db_user}}  -c 'CREATE EXTENSION postgis;'"
      register: psql_result
      failed_when: >
         psql_result.rc != 0 and ("already exists" not in psql_result.stderr)
      changed_when: "psql_result.rc == 0"


#      - name: Delete postgres rds instance, but create a snapshot before doing so
#        local_action:
#          module: rds
#          command: delete
#          instance_name: postgres
#          snapshot: postgres_snapshot
